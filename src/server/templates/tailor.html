<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Tailor Resume – {{JOB_KEY}}</title>
  <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
  <style>
    body { font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif; margin: 2rem; max-width: 900px; }
    .muted { color: #6b7280; font-size: 0.9rem; }
    .panel { border: 1px solid #e5e7eb; border-radius: 8px; padding: 1rem; margin-top: 1rem; }
    textarea { width: 100%; min-height: 100px; padding: 0.5rem; margin-top: 0.25rem; margin-bottom: 0.75rem; font-family: inherit; }
    button { padding: 0.5rem 1rem; }
    .agent-output { background: #f9fafb; padding: 0.75rem; border-radius: 6px; border: 1px solid #e5e7eb; white-space: pre-wrap; }
    .agent-error { color: #b91c1c; margin-top: 0.5rem; }
    .meta { display: flex; gap: 0.5rem; flex-wrap: wrap; }
    table { width: 100%; border-collapse: collapse; margin-top: 0.75rem; }
    th, td { padding: 0.5rem; border-bottom: 1px solid #e5e7eb; text-align: left; }
    th { background: #f3f4f6; }
    .muted-link { color: #9ca3af; pointer-events: none; text-decoration: none; }
  </style>
</head>
<body x-data="tailorPage('{{JOB_KEY}}')" x-init="init()">
  <a :href="`/jobs/${jobKey}`">&larr; Back to job</a>
  <div x-show="loading" class="muted">Loading job...</div>
  <div x-show="error" class="agent-error" x-text="error"></div>
  <template x-if="job">
    <section>
      <h1>Tailor Resume</h1>
      <p class="muted">Generate a role-specific resume from your master PDF.</p>
      <div class="panel">
        <div class="meta">
          <span><strong x-text="job.title"></strong></span>
          <span class="muted">&middot;</span>
          <span x-text="job.company"></span>
          <template x-if="job.company_url">
            <span class="muted">&middot; <a :href="job.company_url" target="_blank" rel="noopener">Company site</a></span>
          </template>
        </div>
        <p class="muted" style="margin-top:0.25rem;">Score: <span x-text="formatScore(job.score)"></span> | LLM Score: <span x-text="formatScore(job.llm_refined_score)"></span></p>
      </div>
      <div class="panel">
        <h2>Tailor for this role</h2>
        <div style="display:flex; align-items:center; gap:0.5rem; margin-bottom:0.5rem; flex-wrap:wrap;">
          <label style="margin:0;">Model</label>
          <select x-model="model" style="width: 180px;">
            <option value="gemini-2.5-flash">gemini-2.5-flash</option>
            <option value="gemini-2.5-pro">gemini-2.5-pro</option>
          </select>
        </div>
        <div style="display:flex; flex-direction:column; gap:0.25rem; margin-bottom:0.75rem;">
          <label>Optional instructions</label>
          <textarea x-model="resumeInstructions" placeholder="Emphasize leadership on cloud migrations..."></textarea>
        </div>
        <div style="display:flex; align-items:center; gap:0.5rem;">
          <button type="button" @click="runResumeTailor()" :disabled="agentLoading" x-text="agentLoading ? 'Tailoring...' : 'Tailor Resume'"></button>
          <span class="muted" x-show="agentLoading">Generating tailored resume...</span>
        </div>
        <div class="agent-error" x-text="agentError" x-show="agentError"></div>
      </div>

      <div class="panel" x-show="agentState.resume_versions && agentState.resume_versions.length">
        <h3>Versions</h3>
        <table>
          <thead>
            <tr>
              <th>Created</th>
              <th>Instructions</th>
              <th>Downloads</th>
            </tr>
          </thead>
          <tbody>
            <template x-for="version in agentState.resume_versions" :key="version.version_id">
              <tr>
                <td x-text="formatTimestamp(version.created_at)"></td>
                <td x-text="version.instructions || '—'"></td>
                <td>
                  <template x-if="version.pdf_url">
                    <a :href="version.pdf_url" target="_blank" rel="noopener">PDF</a>
                  </template>
                  <template x-if="!version.pdf_url">
                    <span class="muted-link">PDF</span>
                  </template>
                  &middot;
                  <template x-if="version.tex_url">
                    <a :href="version.tex_url" target="_blank" rel="noopener">TeX</a>
                  </template>
                  <template x-if="!version.tex_url">
                    <span class="muted-link">TeX</span>
                  </template>
                </td>
              </tr>
            </template>
          </tbody>
        </table>
      </div>
    </section>
  </template>
  <script>
    function tailorPage(jobKey) {
      return {
        jobKey,
        job: null,
        loading: false,
        error: '',
        agentState: { resume_variant: null, resume_versions: [] },
        agentLoading: false,
        agentError: '',
        resumeInstructions: '',
        model: 'gemini-2.5-flash',
        init() {
          this.fetchJob();
          this.fetchAgentState();
        },
        fetchJob() {
          this.loading = true;
          this.error = '';
          fetch(`/job/${encodeURIComponent(jobKey)}`)
            .then((resp) => {
              if (!resp.ok) {
                throw new Error('Unable to load job');
              }
              return resp.json();
            })
            .then((data) => {
              this.job = data;
            })
            .catch((err) => {
              this.error = err.message;
            })
            .finally(() => {
              this.loading = false;
            });
        },
        fetchAgentState() {
          fetch(`/agents/${encodeURIComponent(jobKey)}`)
            .then((resp) => {
              if (!resp.ok) {
                throw new Error('Unable to load current resume variant');
              }
              return resp.json();
            })
            .then((data) => {
              this.agentState.resume_variant = data.resume_variant;
              this.agentState.resume_versions = data.resume_versions || [];
            })
            .catch((err) => {
              this.agentError = err.message;
            });
        },
        runResumeTailor() {
          this.agentLoading = true;
          this.agentError = '';
          fetch(`/agents/${encodeURIComponent(jobKey)}/tailor-resume`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              instructions: this.resumeInstructions || null,
              model: this.model || null,
            }),
          })
            .then((resp) => {
              if (!resp.ok) {
                return resp.json().then((data) => {
                  throw new Error(data.detail || 'Tailoring failed');
                });
              }
              return resp.json();
            })
            .then((data) => {
              this.agentState.resume_variant = data;
              if (data) {
                this.agentState.resume_versions = [data, ...this.agentState.resume_versions].slice(0, 50);
              }
            })
            .catch((err) => {
              this.agentError = err.message;
            })
            .finally(() => {
              this.agentLoading = false;
            });
        },
        formatScore(value) {
          if (value === null || value === undefined) {
            return '-';
          }
          return Number(value).toFixed(3);
        },
        formatTimestamp(value) {
          if (!value) {
            return '';
          }
          return new Date(value).toLocaleString();
        },
      };
    }
  </script>
</body>
</html>
