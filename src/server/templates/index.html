<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>AI Job Assistant â€“ Jobs</title>
  <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;600&display=swap" rel="stylesheet">
  <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
  <style>
    :root {
      --ink: #0f172a;
      --muted: #6b7280;
      --panel: #ffffff;
      --accent: #0ea5e9;
      --accent-strong: #0284c7;
      --border: #e5e7eb;
      --chip: #0f172a0d;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      padding: 2.5rem;
      font-family: "Space Grotesk", "Segoe UI", system-ui, -apple-system, sans-serif;
      background: radial-gradient(circle at 20% 20%, #e0f2fe, #f8fafc 40%), linear-gradient(135deg, #f5f3ff 0%, #f8fafc 50%, #f0f9ff 100%);
      color: var(--ink);
    }
    a { color: var(--accent-strong); text-decoration: none; }
    a:hover { text-decoration: underline; }
    h1 { margin: 0 0 0.35rem; letter-spacing: -0.5px; }
    .shell {
      max-width: 1200px;
      margin: 0 auto;
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }
    .panel {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 14px;
      box-shadow: 0 20px 60px rgba(15, 23, 42, 0.05);
      padding: 1.5rem;
    }
    .filter-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
      gap: 1rem;
      align-items: end;
    }
    .field label { display: block; font-weight: 600; margin-bottom: 0.35rem; }
    .search-row { display: flex; gap: 0.5rem; }
    .search-input {
      flex: 1;
      min-width: 200px;
      padding: 0.6rem 0.75rem;
      border: 1px solid var(--border);
      border-radius: 10px;
      font-size: 1rem;
    }
    button {
      padding: 0.55rem 0.95rem;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: #0f172a;
      color: #fff;
      cursor: pointer;
      font-weight: 600;
      transition: transform 120ms ease, box-shadow 120ms ease, background 120ms ease;
    }
    button:hover { transform: translateY(-1px); box-shadow: 0 8px 20px rgba(15, 23, 42, 0.12); }
    button:disabled { opacity: 0.5; cursor: not-allowed; box-shadow: none; transform: none; }
    .ghost { background: #fff; color: var(--ink); }
    .ghost:hover { background: #f8fafc; }
    .chip-row { display: flex; gap: 0.35rem; flex-wrap: wrap; }
    .chip {
      border-radius: 999px;
      border: 1px solid var(--border);
      background: var(--chip);
      color: var(--ink);
      padding: 0.4rem 0.9rem;
    }
    .chip.active {
      background: #e0f2fe;
      border-color: var(--accent);
      color: var(--accent-strong);
      box-shadow: 0 8px 20px rgba(2, 132, 199, 0.12);
    }
    .muted { color: var(--muted); font-size: 0.95rem; }
    .error { color: #b91c1c; margin-top: 0.5rem; }
    table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
    th, td { padding: 0.75rem 0.5rem; border-bottom: 1px solid var(--border); text-align: left; }
    th { cursor: pointer; font-weight: 600; color: #1f2937; }
    tr:hover { background-color: #f8fafc; }
    .table-wrap { overflow-x: auto; }
    .pagination { display: flex; gap: 0.75rem; align-items: center; flex-wrap: wrap; }
    @media (max-width: 720px) {
      body { padding: 1.25rem; }
      table { font-size: 0.95rem; }
      .search-row { flex-direction: column; }
    }
  </style>
</head>
<body x-data="jobTable()" x-init="init()">
  <div class="shell">
    <div>
      <h1>Stored Jobs</h1>
      <p class="muted">Search, sort, and filter the latest scraped roles. Click any title for detail.</p>
    </div>

    <div class="panel">
      <div class="filter-grid">
        <div class="field">
          <label for="search">Search</label>
          <div class="search-row">
            <input id="search" class="search-input" type="text" placeholder="Search title, company, score" x-model="search" @keyup.enter="applySearch()" />
            <button type="button" @click="applySearch()">Search</button>
            <button type="button" class="ghost" @click="resetSearch()">Reset</button>
          </div>
        </div>
        <div class="field">
          <label>Posted</label>
          <div class="chip-row">
            <template x-for="option in dateFilters" :key="option.value">
              <button type="button"
                class="chip"
                :class="{ 'active': postedWithin === option.value }"
                @click="setDateFilter(option.value)"
                x-text="option.label">
              </button>
            </template>
          </div>
        </div>
      </div>
      <div class="error" x-text="error" x-show="error"></div>
      <p class="muted" x-show="loading">Loading...</p>
      <div class="table-wrap" x-show="!loading && jobs.length">
        <table>
          <thead>
            <tr>
              <th @click="sort('title')">Role</th>
              <th @click="sort('company')">Company</th>
              <th>Posted</th>
              <th>Recruiter</th>
              <th @click="sort('score')">Score</th>
              <th @click="sort('llm_refined_score')">LLM Score</th>
            </tr>
          </thead>
          <tbody>
            <template x-for="job in jobs" :key="job.job_key">
              <tr>
                <td><a :href="`/jobs/${job.job_key}`" x-text="job.title"></a></td>
                <td>
                  <template x-if="job.company_url">
                    <a :href="job.company_url" target="_blank" rel="noopener" x-text="job.company"></a>
                  </template>
                  <template x-if="!job.company_url">
                    <span x-text="job.company"></span>
                  </template>
                </td>
                <td x-text="formatPostingTime(job.posting_time)"></td>
                <td>
                  <template x-if="job.recruiter_url">
                    <a :href="job.recruiter_url" target="_blank" rel="noopener">Profile</a>
                  </template>
                  <template x-if="!job.recruiter_url">
                    <span class="muted">-</span>
                  </template>
                </td>
                <td x-text="formatScore(job.score)"></td>
                <td x-text="formatScore(job.llm_refined_score)"></td>
              </tr>
            </template>
          </tbody>
        </table>
      </div>
      <p class="muted" x-show="!loading && !jobs.length">No jobs found.</p>
      <div class="pagination" style="margin-top: 1rem;">
        <button type="button" class="ghost" @click="goTo(page - 1)" :disabled="page === 1">Prev</button>
        <span>Page <strong x-text="page"></strong> / <span x-text="totalPages"></span></span>
        <button type="button" class="ghost" @click="goTo(page + 1)" :disabled="page === totalPages">Next</button>
      </div>
    </div>
  </div>
  <script>
    function jobTable() {
      return {
        jobs: [],
        page: 1,
        totalPages: 1,
        total: 0,
        sortBy: 'score',
        order: 'desc',
        search: '',
        postedWithin: 'any',
        dateFilters: [
          { label: 'Any time', value: 'any' },
          { label: 'Past day', value: 'day' },
          { label: 'Past week', value: 'week' },
          { label: 'Past month', value: 'month' },
        ],
        loading: false,
        error: '',
        init() {
          this.fetchJobs();
        },
        fetchJobs() {
          this.loading = true;
          this.error = '';
          const params = new URLSearchParams({
            page: this.page,
            sort_by: this.sortBy,
            order: this.order,
            posted_within: this.postedWithin,
          });
          if (this.search.trim()) {
            params.append('search', this.search.trim());
          }
          fetch(`/all?${params.toString()}`)
            .then((resp) => {
              if (!resp.ok) {
                throw new Error('Failed to load jobs');
              }
              return resp.json();
            })
            .then((data) => {
              this.jobs = data.jobs;
              this.total = data.total;
              this.page = data.page;
              this.totalPages = Math.max(1, Math.ceil(data.total / data.page_size));
            })
            .catch((err) => {
              this.error = err.message;
            })
            .finally(() => {
              this.loading = false;
            });
        },
        sort(column) {
          if (this.sortBy === column) {
            this.order = this.order === 'asc' ? 'desc' : 'asc';
          } else {
            this.sortBy = column;
            const highFirst = ['score', 'llm_refined_score'].includes(column);
            this.order = highFirst ? 'desc' : 'asc';
          }
          this.page = 1;
          this.fetchJobs();
        },
        applySearch() {
          this.page = 1;
          this.fetchJobs();
        },
        resetSearch() {
          this.search = '';
          this.postedWithin = 'any';
          this.applySearch();
        },
        setDateFilter(value) {
          this.postedWithin = value;
          this.page = 1;
          this.fetchJobs();
        },
        goTo(target) {
          if (target < 1 || target > this.totalPages) {
            return;
          }
          this.page = target;
          this.fetchJobs();
        },
        formatScore(value) {
          if (value === null || value === undefined) {
            return '-';
          }
          return Number(value).toFixed(3);
        },
        formatPostingTime(value) {
          if (!value) {
            return '-';
          }
          const parsed = new Date(value);
          if (Number.isNaN(parsed.getTime())) {
            return '-';
          }
          return parsed.toLocaleString();
        },
      };
    }
  </script>
</body>
</html>
