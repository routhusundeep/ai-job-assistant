<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Job {{JOB_KEY}}</title>
  <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
  <style>
    body { font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif; margin: 2rem; max-width: 800px; }
    .muted { color: #6b7280; font-size: 0.9rem; }
    .panel { border: 1px solid #e5e7eb; border-radius: 8px; padding: 1rem; margin-top: 1rem; }
    a { color: #2563eb; }
    pre { white-space: pre-wrap; font-family: ui-monospace, SFMono-Regular, Menlo, monospace; }
    textarea { width: 100%; min-height: 70px; padding: 0.5rem; margin-top: 0.25rem; margin-bottom: 0.5rem; font-family: inherit; }
    .agent-section { border-top: 1px solid #e5e7eb; padding-top: 1rem; margin-top: 1rem; }
    .agent-section header { display: flex; justify-content: space-between; align-items: center; }
    .agent-actions { display: flex; gap: 0.5rem; align-items: center; margin-bottom: 0.5rem; }
    .agent-output { background: #f9fafb; padding: 0.75rem; border-radius: 6px; border: 1px solid #e5e7eb; }
    .agent-error { color: #b91c1c; margin-bottom: 0.5rem; }
  </style>
</head>
<body x-data="jobDetail('{{JOB_KEY}}')" x-init="init()">
  <a href="/">&larr; Back to jobs</a>
  <div x-show="loading" class="muted">Loading job...</div>
  <div x-show="error" class="muted" style="color:#b91c1c;" x-text="error"></div>
  <template x-if="job">
    <section>
      <h1 x-text="job.title"></h1>
      <p>
        <strong x-text="job.company"></strong>
        <span class="muted" x-show="job.company_url">&middot; <a :href="job.company_url" target="_blank" rel="noopener">Company site</a></span>
        <span class="muted" x-show="job.recruiter_url">&middot; <a :href="job.recruiter_url" target="_blank" rel="noopener">Recruiter</a></span>
      </p>
      <div class="panel">
        <p><strong>Score:</strong> <span x-text="formatScore(job.score)"></span></p>
        <p><strong>LLM Score:</strong> <span x-text="formatScore(job.llm_refined_score)"></span></p>
        <p><strong>Salary Range:</strong> <span x-text="formatSalary(job.salary_min, job.salary_max)"></span></p>
        <p><strong>Original Posting:</strong> <a :href="job.url" target="_blank" rel="noopener">View on LinkedIn</a></p>
      </div>
      <div class="panel">
        <h2>Description</h2>
        <pre x-text="job.description"></pre>
      </div>
      <div class="panel">
        <h2>Job Assistant</h2>
        <p class="muted">Run fit scoring, tailor the resume, or draft outreach without leaving this page.</p>
        <div class="agent-error" x-text="agentError" x-show="agentError"></div>
        <section class="agent-section">
          <header>
            <h3>Fit Scoring</h3>
            <span class="muted" x-show="agentState.fit_analysis">Updated <span x-text="formatTimestamp(agentState.fit_analysis?.created_at)"></span></span>
          </header>
          <p class="muted">Use existing similarity scores or rerun Gemini for a narrative assessment.</p>
          <label>Optional instructions</label>
          <textarea x-model="fitInstructions" placeholder="Highlight specific accomplishments to mention..."></textarea>
          <div class="agent-actions">
            <button type="button" @click="runFitAnalysis()" :disabled="agentLoading.fit" x-text="agentLoading.fit ? 'Evaluating...' : 'Run Fit Analysis'"></button>
            <span class="muted" x-show="agentLoading.fit">Running fit analysis...</span>
          </div>
          <template x-if="agentState.fit_analysis">
            <div class="agent-output">
              <strong>Score:</strong> <span x-text="formatScore(agentState.fit_analysis?.score)"></span>
              <p x-text="agentState.fit_analysis?.summary"></p>
            </div>
          </template>
        </section>
        <section class="agent-section">
          <header>
            <h3>Tailored Resume</h3>
            <span class="muted" x-show="agentState.resume_variant">Updated <span x-text="formatTimestamp(agentState.resume_variant?.created_at)"></span></span>
          </header>
          <p class="muted">Gemini rewrites your master resume (data/resume.pdf) for this role. Output stays text-only for now.</p>
          <label>Optional instructions</label>
          <textarea x-model="resumeInstructions" placeholder="Emphasize leadership on cloud migrations..."></textarea>
          <div class="agent-actions">
            <button type="button" @click="runResumeTailor()" :disabled="agentLoading.resume">Tailor Resume</button>
            <span class="muted" x-show="agentLoading.resume">Generating tailored resume...</span>
          </div>
          <template x-if="agentState.resume_variant">
            <div class="agent-output">
              <pre x-text="agentState.resume_variant?.content"></pre>
            </div>
          </template>
        </section>
        <section class="agent-section">
          <header>
            <h3>Outreach Drafts</h3>
            <span class="muted" x-show="agentState.outreach">Updated <span x-text="formatTimestamp(agentState.outreach?.created_at)"></span></span>
          </header>
          <p class="muted">Receive a concise email and LinkedIn message aligned to the role.</p>
          <label>Optional instructions</label>
          <textarea x-model="outreachInstructions" placeholder="Reference my open-source work on ..."></textarea>
          <div class="agent-actions">
            <button type="button" @click="runOutreach()" :disabled="agentLoading.outreach">Generate Outreach</button>
            <span class="muted" x-show="agentLoading.outreach">Drafting outreach...</span>
          </div>
          <template x-if="agentState.outreach">
            <div class="agent-output">
              <h4>Email</h4>
              <pre x-text="formatMessage(agentState.outreach?.email_text)"></pre>
              <h4>LinkedIn Message</h4>
              <pre x-text="formatMessage(agentState.outreach?.linkedin_text)"></pre>
            </div>
          </template>
        </section>
      </div>
    </section>
  </template>
  <script>
    function jobDetail(jobKey) {
      return {
        jobKey,
        job: null,
        loading: false,
        error: '',
        agentState: {
          fit_analysis: null,
          resume_variant: null,
          outreach: null,
        },
        agentLoading: { fit: false, resume: false, outreach: false },
        agentError: '',
        fitInstructions: '',
        resumeInstructions: '',
        outreachInstructions: '',
        init() {
          this.fetchJob();
          this.fetchAgentState();
        },
        fetchJob() {
          this.loading = true;
          this.error = '';
          fetch(`/job/${encodeURIComponent(jobKey)}`)
            .then((resp) => {
              if (!resp.ok) {
                throw new Error('Unable to load job');
              }
              return resp.json();
            })
            .then((data) => {
              this.job = data;
            })
            .catch((err) => {
              this.error = err.message;
            })
            .finally(() => {
              this.loading = false;
            });
        },
        fetchAgentState() {
          fetch(`/agents/${encodeURIComponent(jobKey)}`)
            .then((resp) => {
              if (!resp.ok) {
                throw new Error('Unable to load agent state');
              }
              return resp.json();
            })
            .then((data) => {
              this.agentState = data;
            })
            .catch((err) => {
              this.agentError = err.message;
            });
        },
        runFitAnalysis() {
          this.agentLoading.fit = true;
          this.agentError = '';
          fetch(`/agents/${encodeURIComponent(jobKey)}/fit-score`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ instructions: this.fitInstructions || null }),
          })
            .then((resp) => {
              if (!resp.ok) {
                return resp.json().then((data) => {
                  throw new Error(data.detail || 'Fit scoring failed');
                });
              }
              return resp.json();
            })
            .then((data) => {
              this.agentState.fit_analysis = data;
            })
            .catch((err) => {
              this.agentError = err.message;
            })
            .finally(() => {
              this.agentLoading.fit = false;
            });
        },
        runResumeTailor() {
          this.agentLoading.resume = true;
          this.agentError = '';
          fetch(`/agents/${encodeURIComponent(jobKey)}/tailor-resume`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ instructions: this.resumeInstructions || null }),
          })
            .then((resp) => {
              if (!resp.ok) {
                return resp.json().then((data) => {
                  throw new Error(data.detail || 'Tailoring failed');
                });
              }
              return resp.json();
            })
            .then((data) => {
              this.agentState.resume_variant = data;
            })
            .catch((err) => {
              this.agentError = err.message;
            })
            .finally(() => {
              this.agentLoading.resume = false;
            });
        },
        runOutreach() {
          this.agentLoading.outreach = true;
          this.agentError = '';
          fetch(`/agents/${encodeURIComponent(jobKey)}/outreach`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ instructions: this.outreachInstructions || null }),
          })
            .then((resp) => {
              if (!resp.ok) {
                return resp.json().then((data) => {
                  throw new Error(data.detail || 'Outreach failed');
                });
              }
              return resp.json();
            })
            .then((data) => {
              this.agentState.outreach = data;
            })
            .catch((err) => {
              this.agentError = err.message;
            })
            .finally(() => {
              this.agentLoading.outreach = false;
            });
        },
        formatScore(value) {
          if (value === null || value === undefined) {
            return '-';
          }
          return Number(value).toFixed(3);
        },
        formatSalary(min, max) {
          const hasMin = min !== null && min !== undefined;
          const hasMax = max !== null && max !== undefined;
          if (!hasMin && !hasMax) {
            return 'Not provided';
          }
          if (hasMin && hasMax) {
            return `$${Number(min).toLocaleString()} - $${Number(max).toLocaleString()}`;
          }
          if (hasMin) {
            return `$${Number(min).toLocaleString()}`;
          }
          return `$${Number(max).toLocaleString()}`;
        },
        formatTimestamp(value) {
          if (!value) {
            return '';
          }
          return new Date(value).toLocaleString();
        },
        formatMessage(value) {
          if (!value) {
            return '';
          }
          const trimmed = value.trim();
          if (trimmed.startsWith('{')) {
            try {
              const parsed = JSON.parse(trimmed);
              if (typeof parsed === 'object') {
                return Object.values(parsed)
                  .filter(Boolean)
                  .map((entry) => String(entry))
                  .join('\n');
              }
            } catch (err) {
              // fall through to raw text
            }
          }
          return trimmed;
        },
      };
    }
  </script>
</body>
</html>
